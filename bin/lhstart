#!/usr/bin/env ruby

# Start work on a given lighthouse ticket number
#
# * Switch to the related branch if it exists
#
# * Create a branch for the ticket if it doesn't exist
#
# * Check harvest for a project, creating one if it doesn't exist
#
# * Stop any running Harvest timer, starting a new entry for this
#   project (ticket)
#
# Usage:
#
# Create a .lighthouse-config file in the root of your project
# which will contain the base URL for the project (should end
# with the project number and no trailing slash).
#
# Example:
#
#    https://rails.lighthouseapp.com/projects/8994
#
# Calling the script:
#
#    # lhstart 6000
#
# Inspiration for this script derived from:
#
#  * Script for comparing undeployed code to resolved tickets
#    https://gist.github.com/1206151
#
#  * My RunKeeper scraper
#    https://github.com/tjh/rk-spatula/blob/master/runkeeper.rb
#
#  * The Oh My Zsh lighthouse plugin
#    https://github.com/robbyrussell/oh-my-zsh/blob/master/plugins/lighthouse/lighthouse.plugin.zsh
#
#  * Mike Krisher's work sync'ing between Harvest and Things
#    https://github.com/mkrisher/HarvestThings
#

# To view a single ticket, add this suffix to
# the base URL, then append the ticket number
LIGHTHOUSE_URL_TICKET_SUFFIX = 'tickets'

# Get the ticket number given as the only argument
ticket_number = ARGV[0]

raise "You must provide a ticket number" if ticket_number.to_s == ''

# Get a text file which contains
configuration_file = File.open './.lighthouse-config'

# The first line of the config file is the base URL
lighthouse_base_url = configuration_file.gets.strip

# URL for the given ticket
ticket_url_without_permalink = [lighthouse_base_url, LIGHTHOUSE_URL_TICKET_SUFFIX, ticket_number].join('/')

# For testing open the browser to the URL for the given ticket
`open #{ticket_url_without_permalink}`
